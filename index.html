<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="node_modules/opencv.js/opencv.js"></script>
    <script src="node_modules/fabric/dist/fabric.js"></script>
    <script src="scripts/grabcut.js"></script>
    <title>Prototype</title>
</head>
<body>
    <h1>Prototype</h1>
    <input type="file" id="file_input">
    <button id="rect">Rectangle</button>
    <button id="green">Green Line</button>
    <button id="red">Red Line</button>
    <div>
        <h2>Input</h2>
        <canvas id="input"></canvas>
    </div>
    <div>
        <h2>Extracted</h2>
        <canvas id="extracted"></canvas>
    </div>
    <script>
        // create fabric wrappers around canvases
        const input = new fabric.Canvas('input');
        // global state variables
        let cv_image; // cv.Mat image cache
        let result; // result of grabcut operations
        let extracted; // individual extraction result
        // file upload logic
        const file_input = document.getElementById('file_input');
        let image = document.createElement('img');
        file_input.onchange = (e) => {
            image.src = URL.createObjectURL(e.target.files[0]);
            image.onload = _ => {
                input.setDimensions({ width: image.width, height: image.height });
                const fabric_image = new fabric.Image(image);
                input.setBackgroundImage(
                    fabric_image,
                    _ => {
                        input.renderAll();
                        cv_image = cv.imread(image);
                        cv.cvtColor(cv_image, cv_image, cv.COLOR_RGBA2RGB);
                        extracted = new cv.Mat.zeros(image.height, image.width, cv.CV_8UC1);
                        cv.imshow("extracted", extracted);
                    }
                );
            }
        }

        // rectangle drawing settings
        const rect_params = {
            stroke: 'blue',
            strokeWidth: 1,
            fill: 'rgba(0, 0, 0, 0)'
        }

        // rectangle that event handlers will modify
        let rectangle = new fabric.Rect(rect_params);

        // start the rectangle
        input.on('mouse:down', (mouse_event) => {
            const location = mouse_event.pointer;
            rectangle.left = Math.round(location.x);
            rectangle.top = Math.round(location.y);
        });

        // end the rectangle
        input.on('mouse:up', (mouse_event) => {
            const location = mouse_event.pointer;
            rectangle.width = Math.round(location.x - rectangle.left);
            rectangle.height = Math.round(location.y - rectangle.top);
            // add rectangle to the fabric canvas
            console.log(rectangle)
            input.add(rectangle);
            // perform rectangular grabcut
            const rect = new cv.Rect({
                x: rectangle.left,
                y: rectangle.top,
                width: rectangle.width,
                height: rectangle.height
            });
            result = rectGrabCut(cv_image, rect);
            const fg_points = extractMaskPoints(result.mask, isForeground);
            updateMask(result.mask, fg_points, 255);
            cv.imshow("extracted", result.mask);
        });
    </script>
</body>
</html>